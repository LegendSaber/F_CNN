import os
from torch.utils.data import Dataset
import glob
import pandas as pd
import torch
from torchvision import transforms
import cv2
from torchvision.transforms import InterpolationMode
from PIL import Image


class MalwareDataset(Dataset):
    def __init__(self, file_path, is_train):
        self.is_train = is_train
        self.file_path = glob.glob(os.path.join(file_path, "*.png"))
        self.len = len(self.file_path)

        self.transforms_data = transforms.Compose([transforms.ToTensor()])

        # 判断是否是获取训练数据集标志
        if is_train:
            train_label_path = os.path.join(file_path, "..", "trainLabels.csv")
            df = pd.read_csv(train_label_path)
            self.y_data = get_train_label(self.file_path, df)
            self.y_data = torch.Tensor(self.y_data)

            # 随机选择三种数据增强方法中的一种
            transforms_choice = transforms.RandomChoice([transforms.RandomRotation(degrees=45,
                                                                                   interpolation=InterpolationMode.NEAREST,
                                                                                   expand=True),
                                                         transforms.RandomHorizontalFlip(p=0.4),
                                                         transforms.RandomVerticalFlip(p=0.4)])
            # 数据增强以后在缩放到(224, 224)后转成tensor
            self.transforms_data = transforms.Compose([transforms_choice,
                                                       transforms.Resize((224, 224), interpolation=InterpolationMode.NEAREST),
                                                       transforms.ToTensor()])

    def __getitem__(self, index):
        image = cv2.imread(self.file_path[index])
        image = cv2.resize(image, (224, 224))
        image = cv2.applyColorMap(image, cv2.COLORMAP_RAINBOW)
        image = Image.fromarray(image)
        image = self.transforms_data(image)

        if self.is_train:
            return image, self.y_data[index]
        else:
            file_name = get_file_name(self.file_path[index])
            return image, file_name

    def __len__(self):
        return self.len


# 根据文件路径得出不带后缀的文件名
def get_file_name(file_path):
    file_name_begin = file_path.rfind("/") + 1
    file_name_end = file_path.rfind(".")
    return file_path[file_name_begin:file_name_end]


# 从trainLabels.csv中获得文件名对应的类别
def get_train_label(file_path, df):
    train_label = []
    for fp in file_path:
        file_name = get_file_name(fp)
        train_label.append(df[df["Id"] == file_name]["Class"].astype(int).values[0] - 1)
    return train_label